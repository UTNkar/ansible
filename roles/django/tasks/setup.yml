---
- name: install system packages
  apt:
    pkg: "{{ system_packages }}"
    update-cache: yes

- name: install gunicorn
  pip:
    name: gunicorn
    virtualenv: "{{ virtualenv }}"
    virtualenv_command: "pyvenv"
  become_user: "{{ process_user }}"

- name: make sure postgresql server is running
  service: 
    name: postgresql
    state: started

- name: create database
  become_user: postgres
  postgresql_db: 
    name: "{{ db_name }}"

- name: create database user
  become_user: postgres
  postgresql_user: 
    db: "{{ db_name }}"
    name: "{{ db_user }}"
    password: "{{ db_password }}"
    priv: ALL
    encrypted: yes

- name: create system user
  user: 
    name: "{{ process_name }}" 
    shell: /sbin/nologin 
    system: yes